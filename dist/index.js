var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _stringify=require('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);var _path=require('path');var _path2=_interopRequireDefault(_path);var _http=require('http');var _http2=_interopRequireDefault(_http);var _swaggerTools=require('swagger-tools');var _swaggerTools2=_interopRequireDefault(_swaggerTools);var _jsYaml=require('js-yaml');var _jsYaml2=_interopRequireDefault(_jsYaml);var _express=require('express');var _express2=_interopRequireDefault(_express);var _morgan=require('morgan');var _morgan2=_interopRequireDefault(_morgan);var _bodyParser=require('body-parser');var _bodyParser2=_interopRequireDefault(_bodyParser);var _cors=require('cors');var _cors2=_interopRequireDefault(_cors);var _helmet=require('helmet');var _helmet2=_interopRequireDefault(_helmet);var _httpStatus=require('http-status');var _httpStatus2=_interopRequireDefault(_httpStatus);var _nodeFetch=require('node-fetch');var _nodeFetch2=_interopRequireDefault(_nodeFetch);var _dotenv=require('dotenv');var _APIError=require('./helpers/APIError');var _APIError2=_interopRequireDefault(_APIError);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{'default':obj}}// Load .env
(0,_dotenv.config)();(function(){var _this=this;function _callee(){var scraper,res;return _regenerator2['default'].async(function(){function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;scraper=JSON.parse(_fs2['default'].readFileSync('./scraper.json','utf8'));scraper.apiUrl=process.env.API_URL;_context.next=5;return _regenerator2['default'].awrap((0,_nodeFetch2['default'])(String(process.env.SCRAPER_ADMIN_URL)+'/register',{headers:{'Content-Type':'application/json',Accept:'application/json'},method:'POST',body:(0,_stringify2['default'])(scraper)}));case 5:res=_context.sent;if(!scraper.id||!scraper.source.id){_fs2['default'].writeFileSync('./scraper.json',(0,_stringify2['default'])(res))}_context.next=13;break;case 9:_context.prev=9;_context.t0=_context['catch'](0);console.log('Register scraper failed!');process.exit(1);case 13:// Initialize the Swagger middleware
_swaggerTools2['default'].initializeMiddleware(_jsYaml2['default'].safeLoad(_fs2['default'].readFileSync(_path2['default'].join(__dirname,'/api/swagger.yaml'),'utf8')),function(middleware){// Init the server
var app=(0,_express2['default'])();app.use((0,_morgan2['default'])('common'));app.use(_bodyParser2['default'].json({limit:'1mb'}));app.use(_bodyParser2['default'].urlencoded({extended:true}));app.use((0,_cors2['default'])());app.use((0,_helmet2['default'])());app.use(middleware.swaggerMetadata());// Interpret Swagger resources
app.use(middleware.swaggerValidator());// Validate Swagger requests
app.use(middleware.swaggerRouter({// Route validated requests
swaggerUi:_path2['default'].join(__dirname,'/swagger.json'),controllers:_path2['default'].join(__dirname,'./controllers'),useStubs:process.env.NODE_ENV==='development'}));app.use(middleware.swaggerUi());// Swagger UI
app.use(function(req,res,next){return next(new _APIError2['default']('API not found',_httpStatus2['default'].NOT_FOUND))});app.use(function(err,req,res,next){// eslint-disable-line
console.log(err.stack);// eslint-disable-line no-console
var errorResponse={message:err.isPublic?err.message:_httpStatus2['default'][err.status],stack:process.env.NODE_ENV==='development'?err.stack:undefined};res.status(err.status||_httpStatus2['default'].INTERNAL_SERVER_ERROR).json(errorResponse)});// Start the server
_http2['default'].createServer(app).listen(process.env.PORT,process.env.HOST,function(){console.log('Your server is running at http://'+String(process.env.HOST)+':'+String(process.env.PORT));// eslint-disable-line no-console
console.log('Swagger-ui is available at http://'+String(process.env.HOST)+':'+String(process.env.PORT)+'/docs');// eslint-disable-line no-console
})});case 14:case'end':return _context.stop();}}}return _callee$}(),null,_this,[[0,9]])}return _callee})()();